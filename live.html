<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Live â€” Baccarat (3 Bets)</title>
<style>
  :root{
    --ink:#eaf2ff; --mut:#9fb0d9; --g1:#71e1ff; --g2:#25c3ff; --gold:#ffd86a;
    --felt1:#184d57; --felt2:#0f2f35;
    --cardW: clamp(62px, 9.2vw, 92px);
    --cardH: calc(var(--cardW) * 1.39);
    --page-bg: url("https://ricomx.ft-crm.com/media-api/serve/d9ac58ea-8cb5-4568-9bf6-01928a0e087a_BG1.jpg");
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    background:
      linear-gradient(rgba(18,8,38,.12), rgba(8,7,20,.55)),
      var(--page-bg) center/cover no-repeat fixed;
    font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    display:flex; align-items:center; justify-content:center; padding:8px;
    -webkit-tap-highlight-color: transparent;
  }
  @supports (-webkit-touch-callout:none){ body{ background-attachment: scroll; } }

  button{ touch-action:manipulation; }
  .wrap{ width:min(1100px,98vw) }
  .card{
    position:relative; border-radius:22px; padding:12px; overflow:visible;
    background:linear-gradient(180deg,#1b2a56,#0f1832);
    outline:1px solid rgba(255,255,255,.08); box-shadow:0 16px 60px rgba(0,0,0,.55);
  }

  .top{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin:2px 2px 8px; flex-wrap:wrap }
  .leftTop{display:flex; gap:8px; align-items:center}
  .note{font-size:12px; opacity:.9}
  .status{font-weight:800; background:rgba(0,0,0,.35); padding:6px 10px; border-radius:10px}

  /* Back button */
  .backBtn{
    position:fixed; top:calc(10px + env(safe-area-inset-top)); left:calc(10px + env(safe-area-inset-left));
    z-index:99999;
    display:inline-flex; align-items:center; gap:8px;
    padding:10px 12px; border-radius:12px; text-decoration:none;
    font-weight:900; letter-spacing:.3px; color:#0c1220; background:#eaf2ff;
    box-shadow:0 6px 24px rgba(0,0,0,.35), inset 0 -2px 0 rgba(0,0,0,.25);
    user-select:none; -webkit-tap-highlight-color: transparent;
  }
  .backBtn:active{ transform:translateY(1px) }
  .backBtn svg{ width:16px; height:16px }

  .felt{
    position:relative; border-radius:22px; padding:14px 14px 140px;
    background:radial-gradient(closest-side,var(--felt1),var(--felt2));
    outline:1px solid rgba(255,255,255,.08);
    box-shadow:inset 0 0 70px rgba(0,0,0,.6), 0 0 60px rgba(113,225,255,.18), 0 0 80px rgba(192,107,255,.16);
    overflow:hidden; width:100%; aspect-ratio:16/9; max-height:calc(100vh - 140px);
  }

  /* FX + felt art */
  #fx{ position:absolute; inset:0; pointer-events:none; z-index:1 }
  .feltArt{ position:absolute; inset:0; pointer-events:none; opacity:.75; filter:drop-shadow(0 3px 10px rgba(0,0,0,.45)); z-index:0 }
  .feltArt *{ pointer-events:none }
  .feltArt text{ font:900 clamp(12px,1.9vw,18px)/1 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial; letter-spacing:2px; fill:#eaf2ff }

  /* HUD at the TOP of table */
  .hud{
    position:absolute; top:8px; left:50%; transform:translateX(-50%);
    z-index:9; display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center;
  }
  .pill{background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:8px 12px; font-weight:900; font-size:clamp(12px,1.8vw,14px)}

  /* Hands + totals */
  .hand{ position:absolute; top:clamp(18px, 3.5vh, 34px); display:flex; gap:10px; z-index:2; pointer-events:none }
  .hand.player{ left:clamp(14px, 5vw, 60px) }
  .hand.banker{ right:clamp(14px, 5vw, 60px) }
  .tot{ position:absolute; top:6px; font:900 clamp(11px,1.8vw,14px)/1 ui-sans-serif; color:var(--gold); text-shadow:0 2px 6px rgba(0,0,0,.6); transition:transform .18s }
  .tot.p{ left:clamp(14px, 5vw, 60px) } .tot.b{ right:clamp(14px, 5vw, 60px) }
  .tot.pop{ transform:scale(1.18) }

  /* CLICKABLE BET AREAS â€” CENTERED */
  .areas{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    display:grid;
    grid-auto-flow:column;
    grid-template-columns:repeat(3, 1fr);
    align-items:center; justify-items:center;
    gap:clamp(10px,3vw,28px);
    width:min(520px, 72%);
    z-index:6; pointer-events:auto;
  }
  .area{
    appearance:none; -webkit-appearance:none; border:0; background:none; padding:0; margin:0;
    position:relative; cursor:pointer; color:inherit;
  }
  .betSpot{
    display:grid; place-items:center;
    width:clamp(82px,12vw,140px); height:clamp(82px,12vw,140px); border-radius:50%;
    box-shadow:inset 0 0 0 6px rgba(255,255,255,.15);
    background:radial-gradient(circle, rgba(255,255,255,.08), rgba(255,255,255,0) 65%);
    outline:2px dashed rgba(255,255,255,.14);
    transition: transform .12s, box-shadow .25s, outline-color .2s;
  }
  .area:focus-visible .betSpot{ outline:3px solid rgba(113,225,255,.7) }
  .area.sel .betSpot{ transform:translateY(-2px); box-shadow:0 0 18px rgba(113,225,255,.35) inset, 0 0 26px rgba(113,225,255,.22); outline-color:rgba(113,225,255,.5) }

  .spotText{ text-align:center; line-height:1.1 }
  .lab{ display:block; font:900 clamp(13px,2.2vw,18px)/1 ui-sans-serif; letter-spacing:1px }
  .odds{ display:block; opacity:.85; font-weight:800; font-size:clamp(10px,1.6vw,12px); margin-top:2px }

  .player .lab{ color:#c6ffea } .banker .lab{ color:#ffc6c6 } .tie .lab{ color:#ffe39a }
  .area.winPulse .betSpot{ animation:pulseGlow 1.1s ease-in-out 3 }
  @keyframes pulseGlow{
    0%,100%{ box-shadow:inset 0 0 0 6px rgba(255,255,255,.15) }
    50%{ box-shadow:0 0 22px 8px rgba(255,255,255,.18), 0 0 60px 14px rgba(255,255,255,.12), inset 0 0 0 6px rgba(255,255,255,.15) }
  }

  .heartbeat{ animation:beat .52s ease-in-out 2 }
  @keyframes beat{ 0%{transform:scale(1)} 35%{transform:scale(1.03)} 70%{transform:scale(1)} 100%{transform:scale(1)} }

  /* Cards */
  .playing-card{ width:var(--cardW); height:var(--cardH); border-radius:14px; position:relative; outline:2px solid #e5ecff; box-shadow:0 16px 28px rgba(0,0,0,.4); perspective:1000px }
  .card3d{ position:absolute; inset:0; border-radius:14px; transition:transform .6s ease; transform:rotateY(0); transform-style:preserve-3d; -webkit-transform-style:preserve-3d }
  .sideFace{ position:absolute; inset:0; display:grid; place-items:center; border-radius:14px; font-weight:900; backface-visibility:hidden; -webkit-backface-visibility:hidden }
  .back{ background:linear-gradient(180deg,#0e1a3a,#0a1329); color:#9fb0d9; font-size:clamp(20px,3.4vw,28px) }
  .front{ background:radial-gradient(240px 160px at 50% -20%,#fff,#e9eefc 40%,#c8d4f3 100%); color:#1a2050; font-size:clamp(18px,3vw,26px); transform:rotateY(180deg) }
  .reveal .card3d{ transform:rotateY(180deg) }
  .deal-in{ opacity:0; transform:translateY(-24px) scale(.96); animation:deal .44s cubic-bezier(.2,.8,.2,1) forwards }
  @keyframes deal{to{opacity:1; transform:translateY(0) scale(1)}}

  /* Controls */
  .controls{
    position:absolute; left:50%; bottom:10px; transform:translateX(-50%);
    display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:center; z-index:12
  }
  .btn{border:0; border-radius:14px; padding:10px 16px; font-weight:900; cursor:pointer;
       background:linear-gradient(to right,var(--g1),var(--g2)); color:#061018;
       box-shadow:0 0 18px rgba(113,225,255,.5), inset 0 -3px 0 rgba(0,0,0,.35)}
  .btn:disabled{opacity:.55}

  .winner{ position:absolute; inset:0; display:none; place-items:center; z-index:8; pointer-events:none }
  .winner.show{ display:grid; animation:fadeOut 2.4s ease forwards }
  @keyframes fadeOut{ 0%{opacity:1} 75%{opacity:1} 100%{opacity:0} }
  .winBadge{
    padding:16px 26px; border-radius:18px; font:900 clamp(20px,4vw,34px)/1 ui-sans-serif;
    letter-spacing:1px; color:#061018; text-shadow:none;
    box-shadow:0 0 24px rgba(113,225,255,.6); transform:scale(.9);
    animation:pop 650ms ease both;
  }
  .winBadge.player{ background:linear-gradient(90deg,#aaffef,#71f1d6)}
  .winBadge.banker{ background:linear-gradient(90deg,#ffc6cf,#ff9aa5)}
  .winBadge.tie{ background:linear-gradient(90deg,#fff0b5,#ffd86a)}

  /* Voucher modal */
  .overlay{ position:fixed; inset:0; background:rgba(0,0,12,.86); display:none; place-items:center; z-index:13000; backdrop-filter: blur(4px) }
  .overlay.show{ display:grid }
  .modal{
    width:min(520px,92vw); border-radius:20px; padding:18px; text-align:center;
    background:radial-gradient(120% 120% at 50% 0%, #1a1740 0%, #0d1230 60%);
    outline:1px solid rgba(180,220,255,.25); box-shadow:0 24px 90px rgba(0,0,0,.75);
    transform:scale(.96); animation:popIn .28s ease forwards; color:#eaf2ff
  }
  @keyframes popIn{to{transform:scale(1)}}
  .voucher{ font-family:ui-monospace,SFMono-Regular,Menlo,monospace; font-size:clamp(16px,3.8vw,20px); letter-spacing:.6px; padding:12px 14px; border-radius:12px; color:#d8b6ff; background:#0a0d1a; display:inline-block; outline:1px dashed rgba(160,220,255,.4); margin:10px 0 6px; }
  .row{display:flex; gap:10px; justify-content:center; margin-top:10px; flex-wrap:wrap}
  .copy,.close{cursor:pointer; border:0; border-radius:12px; padding:10px 14px; font-weight:900; font-size:clamp(13px,3.6vw,14px)}
  .copy{background:#2b2b2b; color:#fff} .close{background:#fff; color:#111}

  /* Instruction banner OUTSIDE the table */
  .outerBanner{ margin:10px 4px 0; display:flex; justify-content:center; }
  .outerBanner .pill{ background:rgba(0,0,0,.45); border-color:rgba(255,255,255,.16); font-size:clamp(12px,2.2vw,14px); text-align:center; }

  @media (max-width:600px){
    .felt{ padding-bottom:130px }
    .areas{ top:50%; left:50%; transform:translate(-50%, -50%); width:88%; gap:clamp(8px,5vw,16px); }
    .betSpot{ width:clamp(72px,22vw,96px); height:clamp(72px,22vw,96px) }
  }

  /* ===== Table props (shoe, burn card) ===== */
  .shoe{
    position:absolute; right:clamp(10px,4vw,30px); top:clamp(50px,7vh,80px);
    width:clamp(80px,10vw,120px); height:clamp(24px,3vw,36px);
    border-radius:6px; background:linear-gradient(180deg,#2a2a2a,#141414);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.15), 0 12px 26px rgba(0,0,0,.45);
    transform:skewX(-10deg); z-index:2;
  }
  .burnCard{
    position:absolute; right:clamp(12px,4vw,34px); top:clamp(88px,11vh,120px);
    width:clamp(36px,5vw,52px); height:calc(clamp(36px,5vw,52px)*1.39);
    display:grid; place-items:center; font-weight:900; color:#9fb0d9;
    background:linear-gradient(180deg,#0e1a3a,#0a1329); border-radius:8px;
    outline:1px solid rgba(255,255,255,.18);
    box-shadow:0 10px 20px rgba(0,0,0,.5); z-index:2;
  }

  /* ===== Bead plate ===== */
  .beads{
    position:absolute; right:clamp(10px,4vw,26px); bottom:clamp(10px,3vh,16px);
    display:grid; grid-auto-flow:column; gap:6px; z-index:9;
  }
  .bead{ width:16px; height:16px; border-radius:50%; box-shadow:0 0 10px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.2); }
  .bead.p{ background:#49f7d4 }     /* player */
  .bead.b{ background:#ff7a89 }     /* banker */
  .bead.t{ background:#ffd86a }     /* tie */

  /* ===== Chip toss ===== */
  .chip{
    position:absolute; width:20px; height:20px; border-radius:50%;
    background:radial-gradient(circle at 30% 30%, #fff, #eaf2ff 40%, #9fb0d9 80%);
    box-shadow:0 6px 12px rgba(0,0,0,.45); pointer-events:none; z-index:20;
    transform:translate(-50%,-50%);
  }

  /* ===== Card slide-in (from shoe) ===== */
  .slideFrom{
    position:relative;
    transform: translate(var(--sx,0), var(--sy,0)) scale(.98);
    filter: brightness(.95);
    animation: cardSlide .35s cubic-bezier(.2,.8,.2,1) forwards;
  }
  @keyframes cardSlide{ to{ transform: translate(0,0) scale(1); filter:none } }

  /* ===== Felt parallax (optional) ===== */
  #felt.parallax{ perspective: 800px; }
  #felt.parallax .feltArt{ transform: translateZ(0); transition: transform .08s linear; }

  @media (prefers-reduced-motion: reduce){
    .slideFrom,.chip{ animation: none !important; }
  }
  
  /* Keep bet UI above cards, always */
.hand{ z-index:5; }      /* cards layer */
.areas{ z-index:20; }    /* betting circles above cards */
.controls{ z-index:22; } /* Deal button above everything else */

/* More breathing room on small phones */
@media (max-width: 600px){
  /* make cards smaller */
  :root{
    --cardW: clamp(52px, 16vw, 70px);
  }
  /* keep hands close to the top edge */
  .hand{ top: clamp(6px, 2.2vh, 14px); }

  /* push the betting circles down a bit */
  .areas{
    top: 58%;
    width: 88%;
    gap: clamp(10px, 5vw, 18px);
  }
}

/* Extra-tight phones (very narrow / short) */
@media (max-width: 380px), (max-height: 640px){
  :root{ --cardW: clamp(48px, 15vw, 64px); }
  .areas{ top: 60%; }
}

</style>
</head>
<body>

<!-- Back button -->
<a class="backBtn" id="backBtn" href="index.html" aria-label="Back to menu">
  <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M14 6l-6 6 6 6" stroke="#0c1220" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
  Back
</a>

<div class="wrap">
  <div class="card">
    <div class="top">
      <div class="leftTop">
        <div class="note"><b>3 bets only</b> â€¢ Voucher after 3 bets â€¢ Banker 0.95:1 â€¢ Player 1:1 â€¢ Tie 8:1</div>
      </div>
      <div class="status" id="status">Ready</div>
    </div>

    <div class="felt" id="felt" aria-live="polite">
      <canvas id="fx"></canvas>

      <!-- NEW props -->
      <div class="shoe" aria-hidden="true"></div>
      <div class="burnCard" aria-hidden="true">ðŸ‚ </div>
      <div class="beads" id="beads" aria-hidden="true"></div>

      <!-- HUD at top of table -->
      <div class="hud">
        <div class="pill" id="progressTop">Bets left: 3 â€¢ Wins: 0</div>
      </div>

      <svg class="feltArt" viewBox="0 0 1200 700" preserveAspectRatio="none" aria-hidden="true">
        <defs><path id="arc1" d="M200,360 A420,260 0 0,1 1000,360"/></defs>
        <text style="font-size:26px"><textPath href="#arc1" startOffset="50%" text-anchor="middle">RicoBet - BACCARAT</textPath></text>
      </svg>

      <div class="tot p" id="pTot">Player: â€”</div>
      <div class="tot b" id="bTot">Banker: â€”</div>

      <div class="hand player" id="pHand"></div>
      <div class="hand banker" id="bHand"></div>

      <!-- CLICKABLE AREAS -->
      <div class="areas" id="areas" role="group" aria-label="Betting areas">
        <button type="button" class="area player" id="areaPlayer" data-side="player" aria-label="Bet Player">
          <div class="betSpot">
            <div class="spotText"><span class="lab">PLAYER</span><span class="odds">1 : 1</span></div>
          </div>
        </button>
        <button type="button" class="area tie" id="areaTie" data-side="tie" aria-label="Bet Tie">
          <div class="betSpot">
            <div class="spotText"><span class="lab">TIE</span><span class="odds">8 : 1</span></div>
          </div>
        </button>
        <button type="button" class="area banker" id="areaBanker" data-side="banker" aria-label="Bet Banker">
          <div class="betSpot">
            <div class="spotText"><span class="lab">BANKER</span><span class="odds">0.95 : 1</span></div>
          </div>
        </button>
      </div>

      <!-- Controls -->
      <div class="controls">
        <button class="btn" id="dealBtn" type="button" disabled>Deal</button>
      </div>

      <div class="winner" id="winnerOverlay"><div class="winBadge" id="winBadge">Player Win</div></div>
    </div>

    <div class="outerBanner">
      <div class="pill" id="outerBanner">Tap a circle: Player / Tie / Banker</div>
    </div>

  </div>
</div>

<!-- Voucher modal -->
<div class="overlay" id="voucherOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <div id="voucherHeader" style="font-weight:900; font-size:clamp(16px,4.2vw,22px); margin-bottom:6px">Your Voucher</div>
    <div class="voucher" id="voucherText">VIPBAW</div>
    <div class="row">
      <button class="copy" id="copyBtn" type="button">Copy Code</button>
      <button class="close" id="closeBtn" type="button">Close</button>
    </div>
    <div style="color:#a9b7d8;margin-top:8px; font-size:12px">Use this code in your account. One play per user.</div>
  </div>
</div>

<script>
/*** Minimal 3-bet Baccarat with cinematic adds: card slide from shoe, chip toss, ambience, bead plate, parallax ***/
function g(id){return document.getElementById(id)}
function delay(ms){return new Promise(r=>setTimeout(r,ms))}

/* Back button */
(function setupBack(){
  const backBtn=g('backBtn');
  const q=new URLSearchParams(location.search);
  const backUrl=q.get('back');
  backBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    if(backUrl){ location.href = backUrl; return; }
    if(history.length > 1){ history.back(); return; }
    location.href = 'index.html';
  }, {passive:false});
})();

/* Optional URL reset */
const urlp=new URLSearchParams(location.search);
if(urlp.get('reset')==='1'){ try{ localStorage.removeItem('live_3bets_claimed_v3'); localStorage.removeItem('live_3bets_progress_v3'); }catch(e){} }

/* Keys and limits */
const CLAIM_KEY='live_3bets_claimed_v3', PROG_KEY='live_3bets_progress_v3';
const MAX_ROUNDS=3, CODE_WIN='VIPBAW', CODE_LOSE='VIPBAL';

/* Web Audio */
let AC=null, audioReady=false;
function ensureAC(){ if(!AC){ AC=new (window.AudioContext||window.webkitAudioContext)(); } }
function unlockAudio(){
  ensureAC();
  if(AC && AC.state==='suspended'){ AC.resume(); }
  audioReady=true;
}
['pointerdown','touchstart','mousedown'].forEach(ev=>document.addEventListener(ev, unlockAudio, {once:true, passive:true}));

function blip(freq=660, dur=0.08, gain=0.08){
  if(!audioReady||!AC) return;
  const t=AC.currentTime, o=AC.createOscillator(), g=AC.createGain();
  o.type='square'; o.frequency.setValueAtTime(freq,t);
  g.gain.value=gain; g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
  o.connect(g).connect(AC.destination); o.start(t); o.stop(t+dur);
}
function thud(dur=0.12, gain=0.18){
  if(!audioReady||!AC) return;
  const t=AC.currentTime, o=AC.createOscillator(), g=AC.createGain();
  o.type='sine'; o.frequency.setValueAtTime(120,t); o.frequency.exponentialRampToValueAtTime(60,t+dur);
  g.gain.value=gain; g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
  o.connect(g).connect(AC.destination); o.start(t); o.stop(t+dur);
}
function chime(){
  if(!audioReady||!AC) return;
  const now=AC.currentTime;
  [[880,0],[1175,0.08],[1568,0.16]].forEach(([f,ofs])=>{
    const o=AC.createOscillator(), g=AC.createGain();
    o.type='triangle'; o.frequency.value=f;
    g.gain.value=0.12; g.gain.exponentialRampToValueAtTime(0.0001, now+ofs+0.35);
    o.connect(g).connect(AC.destination); o.start(now+ofs); o.stop(now+ofs+0.36);
  });
}

/* Ambience (subtle room tone) */
let ambGain=null, ambNode=null, ambFilter=null;
function startAmbience(){
  if(!audioReady||!AC||ambGain) return;
  ambGain = AC.createGain(); ambGain.gain.value = 0.02;
  ambFilter = AC.createBiquadFilter(); ambFilter.type='lowpass'; ambFilter.frequency.value=800;
  ambGain.connect(AC.destination); ambFilter.connect(ambGain);
  const len = AC.sampleRate * 2;
  const buf = AC.createBuffer(1, len, AC.sampleRate);
  const data = buf.getChannelData(0);
  for (let i=0;i<len;i++) data[i] = (Math.random()*2-1)*0.4;
  ambNode = AC.createBufferSource(); ambNode.buffer=buf; ambNode.loop=true;
  ambNode.connect(ambFilter); ambNode.start();
}
(function(){ const prev=unlockAudio; unlockAudio=function(){ prev(); startAmbience(); }; })();

/* Confetti */
const fx=g('fx'), ctx=fx.getContext('2d');
function resizeFX(){ fx.width=fx.parentElement.clientWidth; fx.height=fx.parentElement.clientHeight }
addEventListener('resize',resizeFX); addEventListener('orientationchange',()=>setTimeout(resizeFX,200)); resizeFX();
function confetti(){ const p=[]; for(let i=0;i<160;i++) p.push({x:fx.width/2,y:120+Math.random()*20,vx:(Math.random()-0.5)*6,vy:(Math.random()-0.5)*5,life:140+Math.random()*60,r:2+Math.random()*3,h:Math.random()*360}); (function loop(){ ctx.clearRect(0,0,fx.width,fx.height); p.forEach(o=>{ o.x+=o.vx;o.y+=o.vy;o.vy+=0.06;o.life--;ctx.globalAlpha=Math.max(0,o.life/200);ctx.fillStyle=`hsl(${o.h},100%,60%)`;ctx.fillRect(o.x,o.y,o.r,o.r);}); ctx.globalAlpha=1; if(p.some(o=>o.life>0)) requestAnimationFrame(loop); })(); }

/* DOM refs */
const status=g('status'), banner=g('outerBanner');
const pHand=g('pHand'), bHand=g('bHand'), pTot=g('pTot'), bTot=g('bTot');
const areas=g('areas'), btnP=g('areaPlayer'), btnT=g('areaTie'), btnB=g('areaBanker');
const dealBtn=g('dealBtn'), progressTop=g('progressTop');
const winnerOverlay=g('winnerOverlay'), winBadge=g('winBadge');
const voucherOverlay=g('voucherOverlay'), voucherText=g('voucherText'), voucherHeader=g('voucherHeader'), copyBtn=g('copyBtn'), closeBtn=g('closeBtn');

/* Beads */
function pushBead(who){
  const beads = g('beads');
  const b = document.createElement('div');
  b.className = 'bead ' + (who==='player'?'p':who==='banker'?'b':'t');
  beads.appendChild(b);
  while(beads.children.length > 6) beads.removeChild(beads.firstChild);
}

/* State */
let roundsPlayed=0, winsCount=0, selection=null, inRound=false, gameOver=false;

/* If already claimed, lock immediately */
const CLAIM_KEY='live_3bets_claimed_v3', PROG_KEY='live_3bets_progress_v3';
const claimed=localStorage.getItem(CLAIM_KEY);
if(claimed){
  const c=JSON.parse(claimed||'{}'); voucherText.textContent=c.code||'VIPBAL';
  voucherHeader.textContent = (c.code==='VIPBAW')
    ? "Redeem your VIP Day rewards now!"
    : "We cover your back, redeem this code to get your VIP Day rewards!";
  voucherOverlay.classList.add('show');
  lock(true); gameOver=true; status.textContent='Voucher already claimed on this device.';
}

/* Resume progress if not claimed */
try{
  const prog=JSON.parse(localStorage.getItem(PROG_KEY) || 'null');
  if(prog && !claimed){ roundsPlayed=Math.min(3, prog.roundsPlayed||0); winsCount=Math.max(0, prog.winsCount||0) }
}catch(e){}
updateHud();

/* Card helpers */
const RANKS=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
const SUITS=['â™ ','â™¥','â™¦','â™£'];
function bacVal(r){ if(r==='A')return 1; if(r==='10'||r==='J'||r==='Q'||r==='K') return 0; return +r }
function total(hand){ return hand.reduce((t,c)=>t+bacVal(c.r),0)%10 }
function newCard(){ const r=RANKS[(Math.random()*RANKS.length)|0]; const s=SUITS[(Math.random()*4)|0]; return {r,s,shown:false,el:null} }
function makeCardEl(card, show=false){
  const el=document.createElement('div'); el.className='playing-card deal-in'+(show?' reveal':'');
  el.innerHTML=`<div class="card3d"><div class="sideFace back">ðŸ‚ </div><div class="sideFace front">${card.r}${card.s}</div></div>`;
  card.el=el; card.shown=!!show; return card;
}

/* Slide-in from shoe to the card position */
function slideFromShoe(el){
  const shoe = document.querySelector('.shoe');
  const felt = document.getElementById('felt');
  if(!shoe || !felt || !el) return;

  const s = shoe.getBoundingClientRect();
  const t = el.getBoundingClientRect();
  const f = felt.getBoundingClientRect();

  const sx = (s.left + s.right)/2 - f.left;
  const sy = (s.top + s.bottom)/2 - f.top;
  const tx = (t.left + t.right)/2 - f.left;
  const ty = (t.top + t.bottom)/2 - f.top;

  const dx = sx - tx;
  const dy = sy - ty;

  el.style.setProperty('--sx', dx + 'px');
  el.style.setProperty('--sy', dy + 'px');
  el.classList.add('slideFrom');
  thud(0.08, 0.12); // slide sfx
}

/* Heartbeat flip pacing */
async function heartbeat(node){
  node.classList.remove('heartbeat'); void node.offsetWidth;
  node.classList.add('heartbeat');
  thud(0.1,0.14);
  await delay(180);
}
function flip(card){
  if(card.shown) return; card.shown=true;
  if(card.el) card.el.classList.add('reveal');
  blip(720,0.09,0.07);
}

/* Selection + chip toss */
function lock(disabled){
  [btnP,btnT,btnB].forEach(b=>{ b.disabled=!!disabled; if(disabled) b.classList.remove('sel') });
  dealBtn.disabled = !!disabled;
  if(disabled) selection=null;
}
function tossChipTo(el){
  const felt = document.getElementById('felt');
  const chip = document.createElement('div');
  chip.className = 'chip'; felt.appendChild(chip);

  const start = { x: felt.clientWidth*0.5, y: felt.clientHeight - 30 };
  const r = el.getBoundingClientRect();
  const f = felt.getBoundingClientRect();
  const end = { x: ((r.left+r.right)/2 - f.left), y: ((r.top+r.bottom)/2 - f.top) };

  const mid = { x: (start.x+end.x)/2, y: Math.min(start.y, end.y) - 60 };
  chip.animate(
    [
      { transform: `translate(${start.x}px,${start.y}px) scale(1)`, offset: 0 },
      { transform: `translate(${mid.x}px,${mid.y}px) scale(1.05)`, offset: .6 },
      { transform: `translate(${end.x}px,${end.y}px) scale(1)`, offset: 1 }
    ],
    { duration: 420, easing: 'cubic-bezier(.2,.8,.2,1)' }
  ).onfinish = ()=> chip.remove();
  blip(520, 0.05, 0.06);
}
function selectSide(side){
  if(inRound||gameOver) return;
  [btnP,btnT,btnB].forEach(b=>b.classList.remove('sel'));
  const map={player:btnP, tie:btnT, banker:btnB}, btn=map[side];
  if(!btn || btn.disabled) return;
  btn.classList.add('sel'); selection=side; dealBtn.disabled=false;
  banner.textContent=`Selected: ${side.toUpperCase()} â€¢ Tap DEAL`;
  status.textContent=`Selected: ${side}`;
  thud(0.1,0.12);
  const spot = btn.querySelector('.betSpot'); if(spot) tossChipTo(spot);
}
areas.addEventListener('pointerup', e=>{ const t=e.target.closest?.('.area'); if(t && !t.disabled) selectSide(t.dataset.side) }, {passive:true});
areas.addEventListener('click', e=>{ const t=e.target.closest?.('.area'); if(t && !t.disabled) selectSide(t.dataset.side) });

/* Round flow */
dealBtn.addEventListener('click', startRound, {passive:true});
async function startRound(){
  if(inRound||gameOver) return;
  if(!selection) return alert('Select Player / Tie / Banker first.');
  if(roundsPlayed>=3) return;
  inRound=true; dealBtn.disabled=true; thud(0.12,0.18);

  // Prepare hands
  pHand.innerHTML=''; bHand.innerHTML='';
  let P = [ makeCardEl(newCard(), false), makeCardEl(newCard(), false) ];
  let B = [ makeCardEl(newCard(), false), makeCardEl(newCard(), false) ];
  P.forEach(c=>{ pHand.appendChild(c.el); slideFromShoe(c.el); });
  B.forEach(c=>{ bHand.appendChild(c.el); slideFromShoe(c.el); });

  // Slower cadence + heartbeat before each flip
  await delay(250);
  await heartbeat(pHand); flip(P[0]); updateTotals(P,B);
  await delay(550);
  await heartbeat(bHand); flip(B[0]); updateTotals(P,B);
  await delay(550);
  await heartbeat(pHand); flip(P[1]); updateTotals(P,B);
  await delay(550);
  await heartbeat(bHand); flip(B[1]); updateTotals(P,B);

  // Natural check
  if(total(P)>=8 || total(B)>=8){ await finishRound(P,B); return; }

  // Player third card
  let playerThird=null;
  if(total(P)<=5){
    playerThird = makeCardEl(newCard(), false);
    pHand.appendChild(playerThird.el); slideFromShoe(playerThird.el);
    await delay(420);
    await heartbeat(pHand); flip(playerThird); P.push(playerThird); updateTotals(P,B);
  }

  // Banker third card (table)
  const bT0=total(B);
  let needBanker=false;
  if(!playerThird){ needBanker=bT0<=5; }
  else{
    const v = bacVal(playerThird.r);
    needBanker = (bT0<=2) || (bT0===3 && v!==8) || (bT0===4 && v>=2 && v<=7) || (bT0===5 && v>=4 && v<=7) || (bT0===6 && (v===6||v===7));
  }
  if(needBanker){
    const b3 = makeCardEl(newCard(), false);
    bHand.appendChild(b3.el); slideFromShoe(b3.el);
    await delay(420);
    await heartbeat(bHand); flip(b3); B.push(b3); updateTotals(P,B);
  }

  await finishRound(P,B);
}

/* Totals + micro-pop */
function updateTotals(P=[],B=[]){
  const p = P.some(c=>c.shown) ? total(P) : 'â€”';
  const b = B.some(c=>c.shown) ? total(B) : 'â€”';
  pTot.textContent = 'Player: ' + p;
  bTot.textContent = 'Banker: ' + b;
  pTot.classList.add('pop'); bTot.classList.add('pop');
  setTimeout(()=>{ pTot.classList.remove('pop'); bTot.classList.remove('pop'); }, 240);
}

/* Finish + winner badge + beads + voucher */
async function finishRound(P,B){
  const pT=total(P), bT=total(B);
  let who = (pT>bT)?'player' : (bT>pT)?'banker':'tie';
  let text = (who==='player') ? 'Player Win' : (who==='banker') ? 'Dealer Win' : 'Tie';
  pushBead(who);
  showWinner(who, text);
  if(who!=='tie' && selection===who) winsCount++;

  roundsPlayed++; saveProgress();
  const left = Math.max(0, 3 - roundsPlayed);
  progressTop.textContent = `Bets left: ${left} â€¢ Wins: ${winsCount}`;

  if(roundsPlayed>=3){
    await delay(800);
    finalizeVoucher((winsCount>0)?'VIPBAW':'VIPBAL');
  }else{
    banner.textContent = `Result: ${text} â€¢ Select next bet (${left} left)`;
    selection=null; [btnP,btnT,btnB].forEach(b=>b.classList.remove('sel'));
    inRound=false; dealBtn.disabled=true;
  }
}
function showWinner(winner, text){
  winBadge.textContent=text;
  winBadge.className='winBadge '+(winner==='player'?'player':winner==='banker'?'banker':'tie');
  [btnP,btnT,btnB].forEach(b=>b.classList.remove('winPulse'));
  if(winner==='player') btnP.classList.add('winPulse');
  else if(winner==='banker') btnB.classList.add('winPulse');
  else btnT.classList.add('winPulse');

  winnerOverlay.classList.remove('show'); void winnerOverlay.offsetWidth;
  winnerOverlay.classList.add('show');

  if(winner==='player'){ confetti(); }
  chime();
}

/* Voucher (locks game) */
function finalizeVoucher(code){
  voucherText.textContent = code;
  voucherHeader.textContent = (code==='VIPBAW')
    ? "Redeem your VIP Day rewards now!"
    : "It's ok, we cover your back, redeem this code to get your VIP Day rewards!";
  voucherOverlay.classList.add('show');
  localStorage.setItem(CLAIM_KEY, JSON.stringify({code, ts:Date.now()}));
  lock(true); gameOver=true;
}
copyBtn.onclick=()=>{ const t=voucherText.textContent.trim(); if(!t) return; navigator.clipboard.writeText(t).then(()=>{ copyBtn.textContent='Copied!'; setTimeout(()=>copyBtn.textContent='Copy Code',1200); }); };
closeBtn.onclick=()=> voucherOverlay.classList.remove('show');

/* HUD + persistence */
function saveProgress(){ try{ localStorage.setItem(PROG_KEY, JSON.stringify({roundsPlayed,winsCount})); }catch(e){} }
function updateHud(){ progressTop.textContent=`Bets left: ${Math.max(0, 3 - roundsPlayed)} â€¢ Wins: ${winsCount}`; }
function init(){ g('outerBanner').textContent='Tap a circle: Player / Tie / Banker'; lock(false); }
init();

/* Parallax tilt (optional) */
(function parallaxFelt(){
  const fel = g('felt');
  fel.classList.add('parallax');
  const maxTilt = 6;
  function tilt(ev){
    const r = fel.getBoundingClientRect();
    const x = (ev.touches?.[0]?.clientX ?? ev.clientX) - r.left;
    const y = (ev.touches?.[0]?.clientY ?? ev.clientY) - r.top;
    const rx = ((y / r.height) - 0.5) * -maxTilt;
    const ry = ((x / r.width)  - 0.5) *  maxTilt;
    fel.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg)`;
  }
  function reset(){ fel.style.transform = 'none'; }
  fel.addEventListener('mousemove', tilt);
  fel.addEventListener('mouseleave', reset);
  fel.addEventListener('touchmove', tilt, {passive:true});
  fel.addEventListener('touchend', reset);
})();
</script>
</body>
</html>
