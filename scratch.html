<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Raspadinha â€” VIP Day (12 Cartas)</title>
<style>
  :root{
    --ink:#eaf2ff; --mut:#9fb0d9; --gold:#ffd86a; --win:#aef7c1;
    --g1:#71e1ff; --g2:#25c3ff; --g3:#c06bff; --bg1:#0b0e22; --bg2:#090b1a;
    --edge:#ffffff18; --ring:#bfe2ff55;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    background:
      radial-gradient(1200px 800px at 50% -10%, rgba(120,115,245,.25), transparent 60%),
      radial-gradient(1400px 900px at 50% 110%, rgba(255,216,106,.12), transparent 65%),
      linear-gradient(180deg,var(--bg1),var(--bg2));
    font:15px/1.5 Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    padding:12px; display:flex; align-items:center; justify-content:center;
  }

  .wrap{ width:min(1100px,96vw); position:relative }
  .top{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom:12px }
  .title{ font-weight:900; letter-spacing:.3px; text-shadow:0 0 18px rgba(113,225,255,.28) }
  .stats{ display:flex; gap:8px; flex-wrap:wrap }
  .pill{ padding:8px 12px; border-radius:12px; font-weight:900; background:rgba(255,255,255,.08); box-shadow:0 0 18px rgba(255,255,255,.08); }
  .pill b{ color:var(--gold) }

  .stage{
    position:relative; border-radius:20px; padding:14px;
    background:linear-gradient(180deg,#151a43,#0d1232);
    outline:1px solid rgba(255,255,255,.08);
    box-shadow:0 24px 100px rgba(0,0,0,.7), inset 0 0 40px rgba(0,0,0,.45);
  }

  .grid{
    display:grid; gap:12px;
    grid-template-columns:repeat(3,1fr);
  }
  @media (min-width:720px){
    .grid{ grid-template-columns:repeat(4,1fr) }
  }

  .card{
    position:relative; border-radius:16px; overflow:hidden; isolation:isolate;
    background:
      radial-gradient(80% 60% at 50% -10%, rgba(255,255,255,.15), transparent 60%),
      linear-gradient(180deg,#14183a,#0a0f26);
    outline:1px solid var(--edge);
    aspect-ratio: 16/10;
    cursor:grab;
    box-shadow:0 12px 40px rgba(0,0,0,.45);
    transition: transform .15s ease;
  }
  .card.revealed{ cursor:default }
  .card:active{ transform:scale(.995) }
  .inner{ position:absolute; inset:0; display:grid; place-items:center; z-index:0 }
  .prize{
    display:grid; place-items:center; text-align:center; padding:10px;
    background:
      conic-gradient(from var(--h,0deg), #7af0ff, #c06bff, #ffd86a, #7af0ff);
    animation:spin 12s linear infinite; border-radius:14px; inset:6px; position:absolute;
  }
  @keyframes spin{ to{ --h:360deg } }
  .prize .pts{
    background:#0c1220; color:#eaf2ff; padding:8px 12px; border-radius:12px;
    font:900 clamp(16px,4vw,18px)/1 ui-sans-serif; letter-spacing:.4px;
    box-shadow:0 0 22px rgba(0,0,0,.5), 0 0 24px rgba(113,225,255,.3) inset;
  }
  .foil{ position:absolute; inset:0; z-index:2; touch-action:none }
  .flag{ position:absolute; top:6px; left:6px; z-index:3; background:#0a0f26; padding:4px 8px; border-radius:999px; font-weight:900; font-size:12px; letter-spacing:.3px; outline:1px solid var(--ring) }
  .flag.done{ background:#0f1a10; color:var(--win); outline:1px solid rgba(174,247,193,.3) }
  .flag.playing{ background:#0a1322; color:#71e1ff; outline:1px solid rgba(113,225,255,.35) }

  .controls{ display:flex; gap:10px; align-items:center; justify-content:center; margin-top:14px; flex-wrap:wrap; color:var(--mut) }
  .btn{ border:0; border-radius:14px; padding:12px 16px; font-weight:900; cursor:pointer;
        background:linear-gradient(to right,#71e1ff,#25c3ff); color:#061018;
        box-shadow:0 0 18px rgba(113,225,255,.45), inset 0 -3px 0 rgba(0,0,0,.35) }

  /* FX canvas */
  #fx{ position:absolute; inset:0; pointer-events:none; border-radius:20px }

  /* Voucher modal */
  .overlay{ position:fixed; inset:0; background:rgba(0,0,12,.86); display:none; place-items:center; z-index:9999; backdrop-filter: blur(4px) }
  .overlay.show{ display:grid }
  .modal{ width:min(520px,92vw); border-radius:20px; padding:18px; text-align:center;
          background:radial-gradient(120% 120% at 50% 0%, #1a1740 0%, #0d1230 60%);
          outline:1px solid rgba(180,220,255,.25); box-shadow:0 24px 90px rgba(0,0,0,.75); color:#eaf2ff }
  .voucher{ font-family:ui-monospace,SFMono-Regular,Menlo,monospace; font-size:clamp(16px,3.8vw,20px);
            letter-spacing:.6px; padding:12px 14px; border-radius:12px; color:#d8b6ff; background:#0a0d1a;
            display:inline-block; outline:1px dashed rgba(160,220,255,.4); margin:10px 0 6px }
  .row{display:flex; gap:10px; justify-content:center; margin-top:10px; flex-wrap:wrap}
  .copy,.close{cursor:pointer; border:0; border-radius:12px; padding:10px 14px; font-weight:900; font-size:clamp(13px,3.6vw,14px)}
  .copy{background:#2b2b2b; color:#fff} .close{background:#fff; color:#111}

  .backBtn{
    position:fixed; top:calc(10px + env(safe-area-inset-top)); left:calc(10px + env(safe-area-inset-left));
    z-index:99999; display:inline-flex; align-items:center; gap:8px;
    padding:10px 12px; border-radius:12px; text-decoration:none; font-weight:900; letter-spacing:.3px;
    color:#0c1220; background:#eaf2ff; box-shadow:0 6px 24px rgba(0,0,0,.35), inset 0 -2px 0 rgba(0,0,0,.25);
    user-select:none;
  }
  .backBtn svg{ width:16px; height:16px }
</style>
</head>
<body>
<a class="backBtn" id="backBtn" href="index.html" aria-label="Voltar ao menu">
  <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M14 6l-6 6 6 6" stroke="#0c1220" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
  Voltar
</a>

<div class="wrap">
  <div class="top">
    <div class="title"><b>Raspadinha VIP Day</b> â€” Raspe atÃ© 5 cartas e junte pontos!</div>
    <div class="stats">
      <div class="pill">Pontos: <b id="points">0</b></div>
      <div class="pill">Tentativas: <b id="tries">5</b>/5</div>
    </div>
  </div>

  <div class="stage">
    <canvas id="fx"></canvas>
    <div id="grid" class="grid"></div>
    <div class="controls">
      <span>Dica: revele ~40% da pelÃ­cula para abrir a carta.</span>
      <button class="btn" id="resetDay" type="button" title="Limpar progresso do dia">Reset do Dia</button>
    </div>
  </div>
</div>

<!-- Voucher modal -->
<div class="overlay" id="voucherOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <div id="voucherHeader" style="font-weight:900; font-size:clamp(16px,4.2vw,22px); margin-bottom:6px">Recompensa VIP Day</div>
    <div class="voucher" id="voucherText">VIP10-ABCDE</div>
    <div class="row">
      <button class="copy" id="copyBtn" type="button">Copiar CÃ³digo</button>
      <button class="close" id="closeBtn" type="button">Fechar</button>
    </div>
    <div style="color:#a9b7d8;margin-top:8px; font-size:12px">Use este cÃ³digo na sua conta.</div>
  </div>
</div>

<!-- SFX -->
<audio id="sScratch" src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@main/slot/stop.mp3" preload="auto"></audio>
<audio id="sWin"     src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@main/slot/win.mp3"  preload="auto"></audio>

<script>
/* ========== CONFIG ========== */
const LOCK_KEY = 'game_lock_choice';
const lockedChoice = localStorage.getItem(LOCK_KEY);
if (lockedChoice && lockedChoice !== 'scratch') { location.href = 'index.html'; }

const todayKey = new Date().toISOString().slice(0,10);
const NS = 'vipday_scratch_' + todayKey;

const DAILY_TRIES = 5;
const POINT_DECK = [10, 0, 15, 25, 0, 20, 10, 30, 50, 5, 15, 0];
const TIERS = [
  { threshold: 50,  label: 'Bronze',  code: 'VIP-BRONZE-50' },
  { threshold: 100, label: 'Prata',   code: 'VIP-PRATA-100' },
  { threshold: 180, label: 'Ouro',    code: 'VIP-OURO-180' },
  { threshold: 260, label: 'Diamante',code: 'VIP-DIAMANTE-260' },
];

/* ========== STATE ========== */
const state = {
  points: +localStorage.getItem(NS+'_points') || 0,
  tries:  +localStorage.getItem(NS+'_tries')  || DAILY_TRIES,
  opened: JSON.parse(localStorage.getItem(NS+'_opened')||'{}'),  // {index:true}
  started: JSON.parse(localStorage.getItem(NS+'_started')||'{}'),// {index:true} â†’ consumed try
  tierWon: localStorage.getItem(NS+'_tierWon') || null
};

/* ========== UI BUILD ========== */
const grid = document.getElementById('grid');
const sScratch = document.getElementById('sScratch');
const sWin = document.getElementById('sWin');
const pointsEl = document.getElementById('points');
const triesEl  = document.getElementById('tries');

pointsEl.textContent = state.points;
triesEl.textContent = state.tries;

function seededShuffle(arr, seedStr){
  const a = arr.slice();
  let seed = 0; for (let i=0;i<seedStr.length;i++) seed = (seed*31 + seedStr.charCodeAt(i))>>>0;
  for (let i=a.length-1;i>0;i--){
    seed = (seed*1664525 + 1013904223)>>>0;
    const j = seed % (i+1);
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}
const deck = seededShuffle(POINT_DECK, todayKey);

deck.forEach((pts, idx) => {
  const card = document.createElement('div');
  card.className = 'card';
  card.dataset.index = idx;
  card.dataset.points = pts;

  const badge = document.createElement('div');
  badge.className = 'flag';
  badge.textContent = state.started[idx] ? (state.opened[idx] ? 'REVELADO' : 'EM JOGO') : 'RASPE';
  if (state.opened[idx]) badge.classList.add('done');
  if (state.started[idx] && !state.opened[idx]) badge.classList.add('playing');
  card.appendChild(badge);

  const inner = document.createElement('div');
  inner.className='inner';
  // show ??? until reveal; store real label in data
  const label = (pts>0 ? `${pts} PONTOS` : 'ðŸ’¤ NADA');
  inner.innerHTML = `
    <div class="prize">
      <div class="pts" data-real="${label}">${state.opened[idx] ? label : '???'}</div>
    </div>`;
  card.appendChild(inner);

  const foil = document.createElement('canvas');
  foil.width = 600; foil.height = 380;
  foil.className = 'foil';
  card.appendChild(foil);

  grid.appendChild(card);

  requestAnimationFrame(() => paintFoil(foil));

  if (state.opened[idx]) revealCard(card, false);

  setupScratch(card, foil, badge, pts, idx);
});

/* ========== FOIL / SCRATCH ========== */
function paintFoil(cvs){
  const ctx = cvs.getContext('2d');
  const {width:w, height:h} = cvs;
  const g = ctx.createLinearGradient(0,0,w,h);
  g.addColorStop(0,'#c9ced7'); g.addColorStop(.5,'#b2b8c6'); g.addColorStop(1,'#c9ced7');
  ctx.globalCompositeOperation='source-over';
  ctx.fillStyle=g; ctx.fillRect(0,0,w,h);

  for(let i=0;i<8;i++){
    const x = Math.random()*w, band = 18+Math.random()*110;
    const grd = ctx.createLinearGradient(x,0,x+band,0);
    grd.addColorStop(0,'rgba(255,255,255,.06)');
    grd.addColorStop(.5,'rgba(255,255,255,.25)');
    grd.addColorStop(1,'rgba(255,255,255,.06)');
    ctx.fillStyle=grd; ctx.fillRect(x,0,band,h);
  }
  for(let i=0;i<2500;i++){
    const x=Math.random()*w, y=Math.random()*h;
    ctx.fillStyle = `rgba(255,255,255,${Math.random()*0.08})`;
    ctx.fillRect(x,y,1,1);
  }
}

function setupScratch(card, foil, badge, pts, idx){
  const ctx = foil.getContext('2d');
  let scratching=false, touched=false;

  function brush(){ return Math.max(16, Math.floor(Math.min(foil.width,foil.height)/18)); }
  function pos(ev){
    const r=foil.getBoundingClientRect();
    const t = ev.touches?.[0] || ev;
    return { x:(t.clientX-r.left)*(foil.width/r.width), y:(t.clientY-r.top)*(foil.height/r.height) };
  }
  function scratch(x,y){
    ctx.globalCompositeOperation='destination-out';
    ctx.beginPath(); ctx.arc(x,y,brush(),0,Math.PI*2); ctx.fill();
    try{ sScratch.currentTime=0; sScratch.volume=.08; sScratch.play(); }catch(_){}
    navigator.vibrate?.(5);
  }
  function revealedPct(){
    const img = ctx.getImageData(0,0,foil.width,foil.height).data;
    let clear=0; for(let i=3;i<img.length;i+=4){ if(img[i]===0) clear++; }
    return clear/(img.length/4);
  }

  function consumeTryOnFirstTouch(){
    if (state.opened[idx] || state.started[idx]) return true;
    if (state.tries <= 0) return false;               // no tries left â†’ block
    state.tries--;
    state.started[idx] = true;
    localStorage.setItem(NS+'_tries', state.tries);
    localStorage.setItem(NS+'_started', JSON.stringify(state.started));
    document.getElementById('tries').textContent = state.tries;
    badge.textContent = 'EM JOGO';
    badge.classList.add('playing');
    // lock game family on first ever touch
    if(!localStorage.getItem(LOCK_KEY)) localStorage.setItem(LOCK_KEY,'scratch');
    return true;
  }

  function handleReveal(){
    if (state.opened[idx]) return;

    const pct = revealedPct();
    if (pct < 0.38) return;

    state.opened[idx]=true;
    localStorage.setItem(NS+'_opened', JSON.stringify(state.opened));

    // now reveal the real label
    const ptsEl = card.querySelector('.pts');
    ptsEl.textContent = pts>0 ? `${pts} PONTOS` : 'ðŸ’¤ NADA';

    if (pts>0){
      state.points += pts;
      localStorage.setItem(NS+'_points', state.points);
      pointsEl.textContent = state.points;
      celebrate(card);
      try{ sWin.volume=.18; sWin.currentTime=0; sWin.play(); }catch(_){}
    }

    revealCard(card, true, pts);
    maybeGiveTier();
  }

  foil.addEventListener('pointerdown', e=>{
    e.preventDefault();
    if (!consumeTryOnFirstTouch()) return; // no tries left â†’ ignore
    scratching=true; touched=true;
    const p=pos(e); scratch(p.x,p.y);
  }, {passive:false});

  foil.addEventListener('pointermove', e=>{ if(!scratching) return; const p=pos(e); scratch(p.x,p.y); }, {passive:false});
  ['pointerup','pointerleave'].forEach(ev=> foil.addEventListener(ev, ()=>{ if(!scratching) return; scratching=false; if(touched) handleReveal(); }, {passive:true}));
}

function revealCard(card, animate=true){
  const foil = card.querySelector('.foil');
  foil.style.opacity = 0;
  foil.style.pointerEvents='none';
  const badge = card.querySelector('.flag');
  badge.textContent = 'REVELADO';
  badge.classList.remove('playing');
  badge.classList.add('done');
  card.classList.add('revealed');
  if (animate){
    card.animate([{transform:'scale(1)'},{transform:'scale(1.02)'},{transform:'scale(1)'}],{duration:320});
  }
}

/* ========== CELEBRATION FX ========== */
const fx = document.getElementById('fx');
const fctx = fx.getContext('2d');
function sizeFX(){ fx.width = fx.clientWidth; fx.height = fx.clientHeight }
addEventListener('resize', sizeFX); sizeFX();

function celebrate(cardEl){
  const r = cardEl.getBoundingClientRect();
  const host = fx.getBoundingClientRect();
  const cx = (r.left - host.left) + r.width/2;
  const cy = (r.top  - host.top ) + r.height/2;
  confetti(cx, cy, 160);
}
function confetti(cx, cy, n=160){
  const p=[];
  for(let i=0;i<n;i++){
    p.push({x:cx,y:cy,vx:(Math.random()-0.5)*6,vy:(Math.random()-0.5)*6-2,life:120+Math.random()*60,h:Math.random()*360,r:2+Math.random()*3});
  }
  (function loop(){
    fctx.clearRect(0,0,fx.width,fx.height);
    let alive=false;
    p.forEach(o=>{
      o.x+=o.vx; o.y+=o.vy; o.vy+=0.06; o.life--;
      if(o.life>0) alive=true;
      fctx.globalAlpha=Math.max(0,o.life/180);
      fctx.fillStyle=`hsl(${o.h},100%,60%)`;
      fctx.fillRect(o.x,o.y,o.r,o.r);
    });
    fctx.globalAlpha=1;
    if(alive) requestAnimationFrame(loop);
  })();
}

/* ========== TIERS / VOUCHERS ========== */
const voucherOverlay = document.getElementById('voucherOverlay');
const voucherText = document.getElementById('voucherText');
const voucherHeader = document.getElementById('voucherHeader');
const copyBtn = document.getElementById('copyBtn');
const closeBtn = document.getElementById('closeBtn');

function maybeGiveTier(){
  let reached = null;
  for (const t of TIERS){ if (state.points >= t.threshold) reached = t; }
  if (!reached) return;
  if (state.tierWon === reached.label) return;
  state.tierWon = reached.label;
  localStorage.setItem(NS+'_tierWon', state.tierWon);
  openVoucher(reached);
}

function openVoucher(tier){
  voucherHeader.textContent = `ParabÃ©ns! VocÃª atingiu o nÃ­vel ${tier.label}`;
  voucherText.textContent = tier.code;
  voucherOverlay.classList.add('show');
}

copyBtn.onclick = async ()=>{
  const t=voucherText.textContent.trim(); if(!t) return;
  try{ await navigator.clipboard.writeText(t); copyBtn.textContent='Copiado!'; setTimeout(()=>copyBtn.textContent='Copiar CÃ³digo',1200);}catch(_){}
};
closeBtn.onclick = ()=> voucherOverlay.classList.remove('show');
voucherOverlay.addEventListener('click', e=>{ if(!e.target.closest('.modal')) voucherOverlay.classList.remove('show'); });

/* ========== RESET / BACK ========== */
document.getElementById('resetDay').onclick = ()=>{
  if(!confirm('Resetar o progresso de hoje?')) return;
  ['_points','_tries','_opened','_started','_tierWon'].forEach(s=>localStorage.removeItem(NS+s));
  location.reload();
};

(function setupBack(){
  const backBtn=document.getElementById('backBtn');
  const q=new URLSearchParams(location.search);
  const backUrl=q.get('back');
  backBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    if(backUrl){ location.href = backUrl; return; }
    if(history.length > 1){ history.back(); return; }
    location.href = 'index.html';
  }, {passive:false});
})();
</script>
</body>
</html>
