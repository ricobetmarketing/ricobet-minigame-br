<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Plinko — VIP Day</title>
<style>
  :root{ --ink:#eaf2ff; --mut:#9fb0d9; --gold:#ffd86a; --g1:#71e1ff; --g2:#25c3ff; --g3:#c06bff;
         --bg1:#0b0e22; --bg2:#090b1a; --winGlow:0 0 22px rgba(255,216,106,.55), 0 0 40px rgba(255,216,106,.35) }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    background:
      radial-gradient(1200px 800px at 50% -10%, rgba(120,115,245,.25), transparent 60%),
      radial-gradient(1400px 900px at 50% 110%, rgba(255,216,106,.12), transparent 65%),
      linear-gradient(180deg,var(--bg1),var(--bg2));
    font:15px/1.5 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    display:flex; align-items:center; justify-content:center; padding:10px;
    overflow:hidden;
  }

  .wrap{ width:min(1100px,96vw); position:relative; z-index:1 }
  .top{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:12px; flex-wrap:wrap }
  .title{ font-weight:900; letter-spacing:.5px; text-shadow:0 0 18px rgba(113,225,255,.28) }
  .badge{ padding:8px 12px; border-radius:12px; background:rgba(255,255,255,.08); font-weight:800; box-shadow:0 0 18px rgba(255,255,255,.08) }

  .stage{
    position:relative; border-radius:24px; padding:16px;
    background:linear-gradient(180deg,#151a43,#0d1232);
    outline:1px solid rgba(255,255,255,.08);
    box-shadow:0 24px 100px rgba(0,0,0,.7), inset 0 0 40px rgba(0,0,0,.45);
  }

  .boardWrap{
    position:relative; width:min(620px,92vw); margin:0 auto;
    border-radius:20px; padding:12px;
    background:linear-gradient(180deg,#1a1d45,#0b0f2b);
    outline:1px solid rgba(255,255,255,.12);
    box-shadow:0 0 40px rgba(113,225,255,.25), 0 0 80px rgba(192,107,255,.25), inset 0 0 50px rgba(0,0,0,.6);
  }
  .boardGlass{
    position:absolute; inset:12px; border-radius:16px; pointer-events:none;
    background:
      linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0) 35%),
      radial-gradient(520px 160px at 50% -15%, rgba(255,255,255,.18), transparent 65%);
    mix-blend-mode:screen;
  }
  canvas#plinko{ display:block; width:100%; height:auto; aspect-ratio: 13/17; background:#090f22; border-radius:16px; outline:1px solid rgba(255,255,255,.12) }

  .controls{ display:flex; gap:10px; align-items:center; justify-content:center; margin-top:12px; flex-wrap:wrap }
  .btn{ border:0; border-radius:14px; padding:12px 16px; font-weight:900; cursor:pointer;
        background:linear-gradient(to right,#71e1ff,#25c3ff); color:#061018; box-shadow:0 0 18px rgba(113,225,255,.45), inset 0 -3px 0 rgba(0,0,0,.35) }

  .hint{ text-align:center; color:var(--mut); font-weight:800; margin-top:6px }

  /* win marquee */
  .marquee{ position:absolute; left:18px; right:18px; top:12px; display:flex; gap:8px; justify-content:center; pointer-events:none }
  .dot{ width:10px; height:10px; border-radius:50%; background:radial-gradient(circle at 40% 40%, #fff, #7af0ff 50%, rgba(122,240,255,0) 70%);
        filter:drop-shadow(0 0 8px #7af0ff); opacity:.25; animation:chase 1.1s linear infinite }
  .dot:nth-child(odd){ animation-delay:.2s } .dot:nth-child(3n){ animation-delay:.5s }
  @keyframes chase{ 0%{opacity:.25} 12%{opacity:1} 24%,100%{opacity:.25} }

  /* sparks canvas */
  #fx{ position:absolute; inset:0; pointer-events:none; border-radius:24px }

  /* voucher modal */
  .overlay{ position:fixed; inset:0; background:rgba(0,0,12,.86); display:none; place-items:center; z-index:9999; backdrop-filter: blur(4px) }
  .overlay.show{ display:grid }
  .modal{ width:min(520px,92vw); border-radius:20px; padding:18px; text-align:center;
          background:radial-gradient(120% 120% at 50% 0%, #1a1740 0%, #0d1230 60%);
          outline:1px solid rgba(180,220,255,.25); box-shadow:0 24px 90px rgba(0,0,0,.75); color:#eaf2ff }
  .voucher{ font-family:ui-monospace,SFMono-Regular,Menlo,monospace; font-size:clamp(16px,3.8vw,20px);
            letter-spacing:.6px; padding:12px 14px; border-radius:12px; color:#d8b6ff; background:#0a0d1a;
            display:inline-block; outline:1px dashed rgba(160,220,255,.4); margin:10px 0 6px }
  .row{display:flex; gap:10px; justify-content:center; margin-top:10px; flex-wrap:wrap}
  .copy,.close{cursor:pointer; border:0; border-radius:12px; padding:10px 14px; font-weight:900; font-size:clamp(13px,3.6vw,14px)}
  .copy{background:#2b2b2b; color:#fff} .close{background:#fff; color:#111}

  .backBtn{
    position:fixed; top:calc(10px + env(safe-area-inset-top)); left:calc(10px + env(safe-area-inset-left));
    z-index:99999; display:inline-flex; align-items:center; gap:8px;
    padding:10px 12px; border-radius:12px; text-decoration:none; font-weight:900; letter-spacing:.3px;
    color:#0c1220; background:#eaf2ff; box-shadow:0 6px 24px rgba(0,0,0,.35), inset 0 -2px 0 rgba(0,0,0,.25);
    user-select:none;
  }
  .backBtn svg{ width:16px; height:16px }

  @media (prefers-reduced-motion: reduce){
    *{animation:none !important; transition:none !important}
  }
</style>
</head>
<body>
<a class="backBtn" id="backBtn" href="index.html" aria-label="Voltar ao menu">
  <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M14 6l-6 6 6 6" stroke="#0c1220" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
  Voltar
</a>

<div class="wrap">
  <div class="top">
    <div class="title"><b>Plinko</b> — Derrube 6 bolas. Se cair no WIN, ganha código!</div>
    <div class="badge" id="status">Bolas: 6</div>
  </div>

  <div class="stage">
    <div class="boardWrap">
      <div class="marquee" aria-hidden="true">
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
      </div>
      <canvas id="plinko" width="520" height="680" aria-label="Tabuleiro Plinko"></canvas>
      <div class="boardGlass" aria-hidden="true"></div>
    </div>

    <canvas id="fx"></canvas>

    <div class="controls">
      <button class="btn" id="dropBtn" type="button">Soltar no Centro</button>
      <button class="btn" id="resetBtn" type="button">Reset</button>
    </div>
    <div class="hint">Toque/click na coluna para soltar a bola — o centro tem mais bolsões “WIN”.</div>
  </div>
</div>

<!-- Voucher modal -->
<div class="overlay" id="voucherOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <div id="voucherHeader" style="font-weight:900; font-size:clamp(16px,4.2vw,22px); margin-bottom:6px">Seu Código</div>
    <div class="voucher" id="voucherText">VIPPL20</div>
    <div class="row">
      <button class="copy" id="copyBtn" type="button">Copiar Código</button>
      <button class="close" id="closeBtn" type="button">Fechar</button>
    </div>
    <div style="color:#a9b7d8;margin-top:8px; font-size:12px">Use este código na sua conta.</div>
  </div>
</div>

<!-- SFX -->
<audio id="sTick" src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@main/slot/stop.mp3" preload="auto"></audio>
<audio id="sWin"  src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@main/slot/win.mp3"  preload="auto"></audio>

<script>
/* ===== Lock & state ===== */
const LOCK_KEY='game_lock_choice';
const lockedChoice = localStorage.getItem(LOCK_KEY);
if(lockedChoice && lockedChoice !== 'plinko'){ location.href='index.html'; }

const CLAIM_KEY='plinko_claimed_v2';
const VOUCHER_KEY='plinko_voucher_v2';
const CODES=['VIPPL10','VIPPL20','VIPPL50'];

/* ===== FX (sparks/confetti) ===== */
const fx = document.getElementById('fx');
const fctx = fx.getContext('2d');
function sizeFX(){ fx.width = fx.parentElement.clientWidth; fx.height = fx.parentElement.clientHeight }
addEventListener('resize', sizeFX); sizeFX();
function confetti(cx, cy, n=160){
  const p=[]; for(let i=0;i<n;i++) p.push({x:cx,y:cy,vx:(Math.random()-0.5)*6,vy:(Math.random()-0.5)*6-2,life:140+Math.random()*60,h:Math.random()*360,r:2+Math.random()*3});
  (function loop(){
    fctx.clearRect(0,0,fx.width,fx.height);
    let alive=false;
    p.forEach(o=>{ o.x+=o.vx; o.y+=o.vy; o.vy+=0.06; o.life--; if(o.life>0) alive=true; fctx.globalAlpha=Math.max(0,o.life/200); fctx.fillStyle=`hsl(${o.h},100%,60%)`; fctx.fillRect(o.x,o.y,o.r,o.r); });
    fctx.globalAlpha=1;
    if(alive) requestAnimationFrame(loop);
  })();
}

/* ===== Plinko board ===== */
const cvs = document.getElementById('plinko');
const ctx = cvs.getContext('2d');
const W=cvs.width, H=cvs.height;
const COLS = 9;     // pockets
const ROWS = 9;     // peg rows
const PEG_SPACING_X = W/(COLS);
const PEG_SPACING_Y = 64;
const PEG_R = 5.5;
const BALL_R = 8.5;

/* pockets — more WIN in middle */
const pockets = new Array(COLS).fill(0).map((_,i)=>({
  x:(i+0.5)*PEG_SPACING_X, w:PEG_SPACING_X, label: (i===4||i===3||i===5)?'WIN':'—'
}));

/* build pegs in staggered rows */
let pegs=[];
for(let r=0;r<ROWS;r++){
  const offset = (r%2? 0.5:0)*PEG_SPACING_X;
  for(let c=0;c<COLS-1+(r%2);c++){
    pegs.push({x:(c+0.5)*PEG_SPACING_X + offset, y: 90 + r*PEG_SPACING_Y});
  }
}

/* state */
let ballsLeft=6, ball=null, won=false;
const statusEl=document.getElementById('status');
const dropBtn=document.getElementById('dropBtn');
const resetBtn=document.getElementById('resetBtn');
const sTick=document.getElementById('sTick');
const sWin=document.getElementById('sWin');

function draw(){
  ctx.clearRect(0,0,W,H);

  // glowing gradient grid
  const g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#0f1a3a'); g.addColorStop(1,'#0b102a');
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

  // vertical neon lines
  ctx.save();
  ctx.globalAlpha = .08;
  for(let x=0;x<=W;x+=PEG_SPACING_X/2){
    ctx.fillStyle='#71e1ff';
    ctx.fillRect(x,0,1,H);
  }
  ctx.restore();

  // pegs (glowy)
  pegs.forEach(p=>{
    ctx.beginPath(); ctx.arc(p.x,p.y,PEG_R,0,Math.PI*2);
    const rg = ctx.createRadialGradient(p.x,p.y,1,p.x,p.y,PEG_R*3);
    rg.addColorStop(0,'#eaf2ff'); rg.addColorStop(1,'rgba(113,225,255,.0)');
    ctx.fillStyle='#eaf2ff'; ctx.fill();
    ctx.fillStyle=rg; ctx.globalAlpha=.7; ctx.beginPath(); ctx.arc(p.x,p.y,PEG_R*3,0,Math.PI*2); ctx.fill();
    ctx.globalAlpha=1;
  });

  // pockets
  pockets.forEach((p,i)=>{
    const isWin = p.label==='WIN';
    // pocket well
    ctx.fillStyle = isWin ? 'rgba(255,216,106,.14)' : 'rgba(255,255,255,.06)';
    ctx.fillRect(i*PEG_SPACING_X, H-90, PEG_SPACING_X, 90);
    // rim
    ctx.strokeStyle='rgba(255,255,255,.18)'; ctx.lineWidth=2;
    ctx.strokeRect(i*PEG_SPACING_X, H-90, PEG_SPACING_X, 90);
    // label
    ctx.font='900 14px system-ui,-apple-system,Segoe UI,Roboto'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillStyle = isWin ? '#ffd86a' : '#9fb0d9';
    ctx.fillText(p.label, p.x, H-46);
    if(isWin){
      // glow
      ctx.shadowColor='rgba(255,216,106,.6)'; ctx.shadowBlur=16;
      ctx.fillText(p.label, p.x, H-46);
      ctx.shadowBlur=0;
    }
  });

  // ball
  if(ball){
    // trail
    ctx.save(); ctx.globalAlpha=.25; ctx.fillStyle='#71e1ff';
    for(let i=0;i<ball.trail.length;i++){
      const t=ball.trail[i]; ctx.beginPath(); ctx.arc(t.x,t.y,BALL_R*(i/ball.trail.length),0,Math.PI*2); ctx.fill();
    }
    ctx.restore();

    // actual ball
    const rg=ctx.createRadialGradient(ball.x-3,ball.y-5,2, ball.x,ball.y,BALL_R+2);
    rg.addColorStop(0,'#fff'); rg.addColorStop(1,'#71e1ff');
    ctx.beginPath(); ctx.arc(ball.x,ball.y,BALL_R,0,Math.PI*2); ctx.fillStyle=rg; ctx.fill();
  }
}

function step(){
  if(ball){
    ball.vy += 0.32; // gravity
    ball.x += ball.vx; ball.y += ball.vy;

    // keep short trail for glow
    ball.trail.unshift({x:ball.x, y:ball.y}); if(ball.trail.length>10) ball.trail.pop();

    // walls
    if(ball.x < BALL_R){ ball.x=BALL_R; ball.vx*= -0.4; tick(); }
    if(ball.x > W-BALL_R){ ball.x=W-BALL_R; ball.vx*= -0.4; tick(); }

    // peg collisions
    for(const p of pegs){
      const dx=ball.x-p.x, dy=ball.y-p.y, d=Math.hypot(dx,dy);
      if(d < PEG_R + BALL_R){
        const ang = Math.atan2(dy,dx);
        const speed = Math.hypot(ball.vx,ball.vy)*0.92;
        const nAng = ang + (Math.random()<0.5? -1:1) * (Math.PI/2.6);
        ball.vx = Math.cos(nAng)*speed*0.75;
        ball.vy = Math.sin(nAng)*speed*0.95;
        ball.x = p.x + Math.cos(ang)*(PEG_R+BALL_R+0.2);
        ball.y = p.y + Math.sin(ang)*(PEG_R+BALL_R+0.2);
        tick(0.07);
      }
    }

    // ground
    if(ball.y >= H-90-BALL_R){
      const idx = Math.min(COLS-1, Math.max(0, Math.floor(ball.x / PEG_SPACING_X)));
      const pk = pockets[idx];
      ball.y = H-50; ball.vx=0; ball.vy=0;
      if(pk.label==='WIN' && !won){
        won=true;
        const code=CODES[(Math.random()*CODES.length)|0];
        localStorage.setItem(VOUCHER_KEY, code);
        localStorage.setItem(CLAIM_KEY, '1');
        try{ sWin.volume=.2; sWin.currentTime=0; sWin.play(); }catch(_){}
        navigator.vibrate?.([18,40,18]);
        // confetti at pocket center
        const r = cvs.getBoundingClientRect();
        const cx = r.left + pk.x*(r.width/W);
        const cy = r.top + (H-70)*(r.height/H);
        confetti(cx, cy, 180);
        openVoucher(code);
        try{ track?.('voucher_shown','VIPDay','plinko', code); }catch(_){}
      }
      ball=null;
      updateStatus();
    }
  }
  draw();
  requestAnimationFrame(step);
}

function updateStatus(){ statusEl.textContent = `Bolas: ${ballsLeft}`; }

function drop(x){
  if(won) return; if(ballsLeft<=0) return; if(ball) return;
  if(!localStorage.getItem(LOCK_KEY)) localStorage.setItem(LOCK_KEY,'plinko');
  ballsLeft--; updateStatus();
  const clamped = Math.min(W-10, Math.max(10, x));
  ball = { x:clamped, y:20, vx:0, vy:0, trail:[] };
}

function tick(vol=.06){
  try{ sTick.volume=vol; sTick.currentTime=0; sTick.play(); }catch(_){}
  navigator.vibrate?.(4);
}

cvs.addEventListener('click', e=>{
  const r=cvs.getBoundingClientRect();
  const x=(e.clientX-r.left)*(W/r.width);
  drop(x);
});
dropBtn.onclick=()=> drop(W/2);
resetBtn.onclick=()=>{
  localStorage.removeItem(CLAIM_KEY);
  localStorage.removeItem(VOUCHER_KEY);
  won=false; ballsLeft=6; updateStatus();
};

updateStatus(); draw(); requestAnimationFrame(step);

/* Voucher modal */
const voucherOverlay = document.getElementById('voucherOverlay');
const voucherText = document.getElementById('voucherText');
const voucherHeader = document.getElementById('voucherHeader');
const copyBtn = document.getElementById('copyBtn');
const closeBtn = document.getElementById('closeBtn');

function openVoucher(code){
  voucherText.textContent = code;
  voucherHeader.textContent = "Resgate agora suas recompensas VIP Day!";
  voucherOverlay.classList.add('show');
}
copyBtn.onclick = async ()=>{
  const t=voucherText.textContent.trim(); if(!t) return;
  try{ await navigator.clipboard.writeText(t); copyBtn.textContent='Copiado!'; setTimeout(()=>copyBtn.textContent='Copiar Código',1200);}catch(_){}
};
closeBtn.onclick = ()=> voucherOverlay.classList.remove('show');
voucherOverlay.addEventListener('click', e=>{ if(!e.target.closest('.modal')) voucherOverlay.classList.remove('show'); });

/* Auto-show if already claimed */
if(localStorage.getItem(CLAIM_KEY)){
  setTimeout(()=> openVoucher(localStorage.getItem(VOUCHER_KEY)||CODES[0]), 200);
}

/* Back behavior */
(function setupBack(){
  const backBtn=document.getElementById('backBtn');
  const q=new URLSearchParams(location.search);
  const backUrl=q.get('back');
  backBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    if(backUrl){ location.href = backUrl; return; }
    if(history.length > 1){ history.back(); return; }
    location.href = 'index.html';
  }, {passive:false});
})();

/* Minimal Matomo shim */
function track(){ /* no-op */ }
</script>
</body>
</html>
